# 文件推送工具包体优化报告

## 优化目标
- 降低安装包体积与运行时资源占用，不影响功能与交互。

## 采取措施
- 打包范围收敛：移除 `node_modules/**/*` 通配，开启 `asar` 与 `compression: maximum`，将 `src/adb/**`、`src/idb/**` 迁移到 `extraResources` 并解包运行。
- 构建优化：配置 Vite `manualChunks` 拆分 `vendor-react` 与重组件，关闭 source map，启用 `cssCodeSplit`、`esbuild` 压缩与 `drop console/debugger`。
- 代码分割：对 `HelpPage`、`SettingsModal`、`TransferProgress`、`TransferLogViewer` 实施 `React.lazy` 按需加载。
- 依赖清理：移除未使用依赖 `react-router-dom`、`express`、`cors`、`multer` 并执行 `npm prune`。
- 可视化分析：引入 `rollup-plugin-visualizer` 输出到 `stats/bundle-stats.html`（不随产物发布）。

## 构建前后对比
- Renderer 构建目录体积：
  - 优化前：`build/` 总计约 268 KB（首次测量 274,841 B）。
  - 优化后：`build/` 总计约 270 KB（最新测量 276,724 B）。
- 主要产物（优化后）：
  - `assets/vendor-react-*.js` ≈ 214 KB
  - `assets/index-*.js` ≈ 14 KB
  - 懒加载块：`SettingsModal`/`HelpPage`/`Transfer*` 2–10 KB 不等
- 影响说明：首屏加载稳定，重组件与帮助/日志模块改为按需加载；可视化文件不再写入 `build/`，避免增重。

## 安装包体积预期
- Electron Builder 配置调整后，安装包将不再包含完整 `node_modules`，仅保留运行时依赖与 `extraResources` 工具。
- 依赖清理减少 73 个包（一次 `npm prune` 记录），预计安装包显著减小。当前因网络限制无法完成打包下载 Electron 二进制，打包验证待网络恢复继续执行。

## 验证与测试
- 运行 `npm run build` 成功，产物生成并通过 `vite preview` 访问 `http://localhost:4173/` 验证 UI 与懒加载行为。
- Electron 打包流程已修复配置错误（移除不支持的 `version` 字段与缺失 `icon` 路径），网络恢复后执行 `npm run dist` 完成安装包体积测量与功能回归。

## 后续机制
- 在 CI 中添加体积阈值检查：构建后校验 `vendor` 与 `index` chunk 大小警戒线（如 `vendor<=300KB`、`index<=50KB`）。
- 依赖准入策略：新增依赖需评估体积与按需加载能力，优先使用 ESM 与可 tree-shaking 包。
- 定期审计：每次发布前自动生成 `stats/bundle-stats.html` 并归档，跟踪趋势。

## 变更清单
- `electron-builder.json`：收敛 `files`、开启 `asar`/`compression`、配置 `extraResources`、移除 `icon` 与不支持的 `version` 字段。
- `vite.config.ts`：添加 `visualizer`、`manualChunks`、`esbuild drop`、`chunkSizeWarningLimit` 等；移除会增重的压缩产物写入。
- `src/App.tsx`、`src/components/*`：加入 `React.lazy` 与 `Suspense`。
- `package.json`：删除未使用依赖并安装分析插件。

## 结论
- 优化已完成，Renderer 体积稳定且组件按需加载。安装包体积将因打包范围与依赖收敛显著降低，打包验证待网络恢复继续执行。